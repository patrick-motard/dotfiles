#!/bin/bash
# Focus a tab by URL pattern, or open it if not found.
# Usage: spawn --userscript focus-or-open <url>
#
# Behavior:
# - If already on target URL: close the tab (toggle off)
# - Otherwise: try to focus existing tab, or open new one

URL="${1:-qute://bindings}"

# Normalize URLs for comparison
CURRENT_URL="${QUTE_URL%/}"
TARGET_URL="${URL%/}"

# If we're already on the target URL, close this tab (toggle behavior)
if [[ "$CURRENT_URL" == "$TARGET_URL" ]]; then
    echo "tab-close" >> "$QUTE_FIFO"
    exit 0
fi

# Try to select existing tab first.
# If this fails (no matching tab), qutebrowser shows an error.
# User can press ? again, which will then open a new tab since we
# check tab count below.

# Count tabs with this URL in the title/URL by checking buffer
# Actually, we can't easily do this. Let's use a simple state file approach.

STATE_FILE="/tmp/qute-singleton-${URL//[^a-zA-Z0-9]/_}"

if [[ -f "$STATE_FILE" ]]; then
    # We've opened this before, try to select it
    echo "tab-select $URL/" >> "$QUTE_FIFO"
else
    # First time - open and record
    touch "$STATE_FILE"
    echo "open -t $URL" >> "$QUTE_FIFO"
fi
